generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int              @id @default(autoincrement())
  email         String           @unique
  password      String
  createdAt     DateTime         @default(now())
  role          String           @default("developer")
  updatedAt     DateTime         @default(now()) @updatedAt
  verified      Boolean          @default(true)
  apps          App[]
  publications  AppPublication[]
  canvasHistory CanvasHistory[]
  mediaFiles    MediaFile[]
  notifications Notification[]
}
model App {
  id               Int                @id @default(autoincrement())
  name             String
  description      String?
  status           AppStatus          @default(Draft)
  archived         Boolean            @default(false)
  ownerId          Int
  templateId       Int?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  isPublished      Boolean            @default(false)
  publishedVersion String?
  publishedAt      DateTime?
  owner            User               @relation(fields: [ownerId], references: [id])
  template         Template?          @relation(fields: [templateId], references: [id])
  issues           AppIssue[]
  metrics          AppMetric[]
  publications     AppPublication[]
  schemas          AppSchema[]
  warnings         AppWarning[]
  canvas           Canvas?
  components       Component[]
  mediaFiles       MediaFile[]
  queryPerformance QueryPerformance[]
  userTables       UserTable[]
  workflows        Workflow[]

  // App-level relations added below
  appRoles         AppRole[]
  appUsers         AppUser[]
  appPages         AppPage[]
  pageAccess       PageAccess[]

  @@index([ownerId])
  @@index([status])
  @@index([templateId])
  @@index([isPublished])
}


model Template {
  id            Int      @id @default(autoincrement())
  name          String
  description   String
  preview_image String?
  app_schema    Json
  category      String   @default("General")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  apps          App[]

  @@index([category])
}

model Component {
  id         Int    @id @default(autoincrement())
  name       String
  type       String
  appId      Int
  properties Json
  app        App    @relation(fields: [appId], references: [id])
}

model Workflow {
  id        Int      @id @default(autoincrement())
  name      String
  appId     Int
  pageId    String?
  elementId String?
  nodes     Json
  edges     Json
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([appId, elementId])
  @@index([appId])
  @@index([pageId])
  @@index([elementId])
}

model Otp {
  id        Int      @id @default(autoincrement())
  email     String
  otp       String
  type      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, type])
}

model AppSchema {
  id            Int        @id @default(autoincrement())
  appId         Int
  name          String
  createdAt     DateTime   @default(now())
  data          AppData[]
  relatedFields AppField[] @relation("FieldRelation")
  fields        AppField[]
  app           App        @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
}

model AppField {
  id              Int        @id @default(autoincrement())
  schemaId        Int
  name            String
  type            FieldType
  constraints     Json       @default("{}")
  relatedSchemaId Int?
  createdAt       DateTime   @default(now())
  relatedSchema   AppSchema? @relation("FieldRelation", fields: [relatedSchemaId], references: [id])
  schema          AppSchema  @relation(fields: [schemaId], references: [id], onDelete: Cascade)

  @@index([schemaId])
}

model AppData {
  id        Int       @id @default(autoincrement())
  schemaId  Int
  data      Json
  createdAt DateTime  @default(now())
  schema    AppSchema @relation(fields: [schemaId], references: [id], onDelete: Cascade)

  @@index([schemaId])
}

/* ---------- NEW APP-LEVEL MODELS (for App Role System) ---------- */

/*
  AppUser:
    - Represents an end-user for a specific App (distinct from platform User)
    - Used for app-level login, role assignment, page access
*/
model AppUser {
  id         Int        @id @default(autoincrement())
  appId      Int
  email      String
  password   String?
  name       String?
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @default(now()) @updatedAt

  app        App        @relation(fields: [appId], references: [id], onDelete: Cascade)
  roles      AppUserRole[]
  pageAccess PageAccess[]
  logs       RoleLog[]

  @@unique([appId, email])
  @@index([appId])
}

/*
  AppRole:
    - Roles defined by the app owner (e.g., admin, staff, user, manager)
    - isPredefined indicates built-ins like 'admin' created automatically when app is created
*/
model AppRole {
  id           Int           @id @default(autoincrement())
  appId        Int
  name         String
  slug         String
  description  String?
  isPredefined Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt

  app          App           @relation(fields: [appId], references: [id], onDelete: Cascade)
  roleUsers    AppUserRole[]
  rolePages    RolePage[]

  @@unique([appId, slug])
  @@index([appId])
}

/*
  AppUserRole:
    - Mapping between AppUser and AppRole (many-to-many)
*/
model AppUserRole {
  id        Int      @id @default(autoincrement())
  appUser   AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)
  appUserId Int
  appRole   AppRole  @relation(fields: [appRoleId], references: [id], onDelete: Cascade)
  appRoleId Int
  grantedBy Int?     // reference to platform User.id or AppUser.id who granted
  grantedAt DateTime @default(now())

  @@unique([appUserId, appRoleId])
  @@index([appUserId])
  @@index([appRoleId])
}

/*
  AppPage:
    - Pages that belong to an App (used by UI when owner selects pages for role/page access)
*/
model AppPage {
  id        Int        @id @default(autoincrement())
  appId     Int
  title     String
  slug      String
  path      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @default(now()) @updatedAt

  app       App        @relation(fields: [appId], references: [id], onDelete: Cascade)
  rolePages RolePage[]
  pageAccess PageAccess[]

  @@unique([appId, slug])
  @@index([appId])
}

/*
  RolePage:
    - Mapping of which pages a role has access to
*/
model RolePage {
  id       Int     @id @default(autoincrement())
  roleId   Int
  pageId   Int
  appRole  AppRole @relation(fields: [roleId], references: [id], onDelete: Cascade)
  appPage  AppPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([roleId, pageId])
  @@index([roleId])
  @@index([pageId])
}

/*
  PageAccess:
    - Explicit page access assigned to an AppUser (optional; you can use role-based access primarily)
    - pageSlug stored for fast checks in workflows
*/
model PageAccess {
  id        Int      @id @default(autoincrement())
  appId     Int
  appUserId Int
  pageId    Int
  pageSlug  String
  createdAt DateTime @default(now())

  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  user      AppUser  @relation(fields: [appUserId], references: [id], onDelete: Cascade)
  page      AppPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([appUserId, pageId])
  @@index([appId])
  @@index([appUserId])
  @@index([pageId])
}

/*
  RoleLog:
    - Logs role checks/assignments (persisted to DB per your requirement)
*/
model RoleLog {
  id         Int      @id @default(autoincrement())
  appId      Int?
  appUserId  Int?
  actorId    Int?     // who performed action (platform user or app user)
  roleSlug   String
  action     String   // CHECK | ASSIGN | DENY | GRANT
  details    String?
  workflowId Int?
  nodeId     String?
  createdAt  DateTime @default(now())
  appUser AppUser? @relation(fields: [appUserId], references: [id])


  @@index([appId])
  @@index([appUserId])
  @@index([createdAt])
}


model Video {
  id        Int      @id @default(autoincrement())
  title     String
  url       String
  category  String
  createdAt DateTime @default(now())

  @@index([category])
}

model AppMetric {
  id         Int      @id @default(autoincrement())
  appId      Int
  activeDays Int
  downtime   Float
  totalUsers Int
  traffic    Int
  createdAt  DateTime @default(now())
  app        App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([createdAt])
}

model AppIssue {
  id          Int           @id @default(autoincrement())
  appId       Int
  severity    IssueSeverity
  description String
  status      IssueStatus   @default(open)
  createdAt   DateTime      @default(now())
  app         App           @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([severity])
  @@index([status])
}

model AppWarning {
  id        Int      @id @default(autoincrement())
  appId     Int
  message   String
  createdAt DateTime @default(now())
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([createdAt])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model BlacklistedToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([token])
  @@index([expiresAt])
}

model Canvas {
  id          Int             @id @default(autoincrement())
  appId       Int             @unique
  name        String          @default("Untitled Canvas")
  description String?
  width       Int             @default(1200)
  height      Int             @default(800)
  background  Json            @default("{\"color\": \"#ffffff\", \"opacity\": 100}")
  canvasState Json?
  gridEnabled Boolean         @default(true)
  snapEnabled Boolean         @default(true)
  zoomLevel   Float           @default(1.0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  app         App             @relation(fields: [appId], references: [id], onDelete: Cascade)
  elements    CanvasElement[]
  history     CanvasHistory[]

  @@index([appId])
}

model CanvasElement {
  id           Int                  @id @default(autoincrement())
  canvasId     Int
  elementId    String               @unique
  type         ElementType
  name         String               @default("Untitled Element")
  x            Float                @default(0)
  y            Float                @default(0)
  width        Float                @default(100)
  height       Float                @default(50)
  rotation     Float                @default(0)
  zIndex       Int                  @default(0)
  locked       Boolean              @default(false)
  visible      Boolean              @default(true)
  groupId      String?
  parentId     Int?
  properties   Json                 @default("{}")
  styles       Json                 @default("{}")
  constraints  Json                 @default("{}")
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  canvas       Canvas               @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  parent       CanvasElement?       @relation("ElementHierarchy", fields: [parentId], references: [id])
  children     CanvasElement[]      @relation("ElementHierarchy")
  interactions ElementInteraction[]
  validations  ElementValidation[]

  @@index([canvasId])
  @@index([elementId])
  @@index([type])
  @@index([groupId])
  @@index([zIndex])
}

model ElementInteraction {
  id        Int           @id @default(autoincrement())
  elementId Int
  event     String
  action    Json
  createdAt DateTime      @default(now())
  element   CanvasElement @relation(fields: [elementId], references: [id], onDelete: Cascade)

  @@index([elementId])
}

model ElementValidation {
  id        Int           @id @default(autoincrement())
  elementId Int
  rule      String
  value     Json
  message   String
  createdAt DateTime      @default(now())
  element   CanvasElement @relation(fields: [elementId], references: [id], onDelete: Cascade)

  @@index([elementId])
}

model CanvasHistory {
  id        Int      @id @default(autoincrement())
  canvasId  Int
  action    String
  elementId String?
  oldState  Json?
  newState  Json?
  userId    Int
  createdAt DateTime @default(now())
  canvas    Canvas   @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([canvasId])
  @@index([userId])
  @@index([createdAt])
}

model MediaFile {
  id               Int      @id @default(autoincrement())
  filename         String
  originalName     String
  mimeType         String
  size             Int
  url              String
  path             String?
  thumbnail        String?
  userId           Int
  appId            Int?
  elementId        String?
  workflowId       Int?
  dropPosition     Json?
  validationResult Json?
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())
  app              App?     @relation(fields: [appId], references: [id])
  user             User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([appId])
  @@index([mimeType])
  @@index([elementId])
  @@index([workflowId])
}

model UserTable {
  id        Int      @id @default(autoincrement())
  appId     Int
  tableName String
  columns   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  app       App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@unique([appId, tableName])
  @@index([appId])
  @@index([tableName])
}



model QueryPerformance {
  id              Int      @id @default(autoincrement())
  appId           Int
  tableName       String
  queryType       String
  executionTimeMs Int
  rowCount        Int
  createdAt       DateTime @default(now())
  app             App      @relation(fields: [appId], references: [id], onDelete: Cascade)

  @@index([appId])
  @@index([tableName])
  @@index([queryType])
  @@index([createdAt])
}

model AppPublication {
  id             Int      @id @default(autoincrement())
  appId          Int
  name           String
  description    String
  version        String
  isPublic       Boolean  @default(false)
  publishedAt    DateTime @default(now())
  canvasSnapshot String?
  publishedBy    Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  app            App      @relation(fields: [appId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [publishedBy], references: [id])

  @@unique([appId, version])
  @@index([appId])
  @@index([isPublic])
  @@index([publishedAt])
  @@index([publishedBy])
}

model test_table {
  id   Int     @id @default(autoincrement())
  name String?
}

enum FieldType {
  text
  number
  date
}

enum IssueSeverity {
  severe
  mild
  low
}

enum IssueStatus {
  open
  resolved
}

enum AppStatus {
  Draft
  Published
  Active
}

enum ElementType {
  TEXT_FIELD
  TEXT_AREA
  DROPDOWN
  CHECKBOX
  RADIO_BUTTON
  PHONE_FIELD
  TOGGLE
  DATE_PICKER
  IMAGE
  BUTTON
  UPLOAD_MEDIA
  ADD_MEDIA
  SHAPE
  ICON_MINIMIZE
  ICON_MAXIMIZE
  ICON_CLOSE
  ICON_SETTINGS
  ICON_REFRESH
  ICON_INFO
  ICON_HELP
  ICON_SEARCH
}
